<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>BMP from a Blue Pill - The Drone Embedded Operating System</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="getting-started.html"><strong aria-hidden="true">1.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="hardware.html"><strong aria-hidden="true">1.1.</strong> Hardware</a></li><li class="chapter-item expanded "><a href="bmp-from-bluepill.html" class="active"><strong aria-hidden="true">1.2.</strong> BMP from a Blue Pill</a></li><li class="chapter-item expanded "><a href="hello-world.html"><strong aria-hidden="true">1.3.</strong> Hello, world!</a></li></ol></li><li class="chapter-item expanded "><a href="bluepill-blink.html"><strong aria-hidden="true">2.</strong> Blink an LED</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="bluepill-blink/full-speed.html"><strong aria-hidden="true">2.1.</strong> Run at Full Speed</a></li><li class="chapter-item expanded "><a href="bluepill-blink/sys-tick.html"><strong aria-hidden="true">2.2.</strong> Work with a Timer</a></li></ol></li><li class="chapter-item expanded "><a href="concurrency.html"><strong aria-hidden="true">3.</strong> Concurrency</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="fibers.html"><strong aria-hidden="true">3.1.</strong> Fibers</a></li><li class="chapter-item expanded "><a href="processes.html"><strong aria-hidden="true">3.2.</strong> Processes</a></li><li class="chapter-item expanded "><a href="threads.html"><strong aria-hidden="true">3.3.</strong> Threads</a></li><li class="chapter-item expanded "><a href="tasks.html"><strong aria-hidden="true">3.4.</strong> Tasks</a></li><li class="chapter-item expanded "><a href="message-passing.html"><strong aria-hidden="true">3.5.</strong> Message-Passing</a></li></ol></li><li class="chapter-item expanded "><a href="heap.html"><strong aria-hidden="true">4.</strong> Dynamic Memory</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="heaptrace.html"><strong aria-hidden="true">4.1.</strong> Heap Tracing</a></li></ol></li><li class="chapter-item expanded "><a href="reg.html"><strong aria-hidden="true">5.</strong> Memory-Mapped Registers</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="reg/api.html"><strong aria-hidden="true">5.1.</strong> API Summary</a></li><li class="chapter-item expanded "><a href="reg/tag.html"><strong aria-hidden="true">5.2.</strong> Tags</a></li><li class="chapter-item expanded "><a href="periph.html"><strong aria-hidden="true">5.3.</strong> Peripheral Mappings</a></li></ol></li><li class="chapter-item expanded "><a href="testing.html"><strong aria-hidden="true">6.</strong> Testing</a></li><li class="chapter-item expanded "><a href="extensibility.html"><strong aria-hidden="true">7.</strong> Extensibility</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="extensibility/cli.html"><strong aria-hidden="true">7.1.</strong> Drone CLI</a></li><li class="chapter-item expanded "><a href="extensibility/platform.html"><strong aria-hidden="true">7.2.</strong> Platform-Specific Layer</a></li><li class="chapter-item expanded "><a href="extensibility/vendor.html"><strong aria-hidden="true">7.3.</strong> Vendor-Specific Layer</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">The Drone Embedded Operating System</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="black-magic-probe-from-a-blue-pill"><a class="header" href="#black-magic-probe-from-a-blue-pill">Black Magic Probe from a Blue Pill</a></h1>
<p>This chapter describes the process of making a Black Magic Probe from a Blue
Pill board. The steps were tested on Ubuntu 18.04.3 LTS and Arch Linux 5.3.7.</p>
<h2 id="preparation"><a class="header" href="#preparation">Preparation</a></h2>
<p>The process requires the following packages to be installed:</p>
<pre><code class="language-shell">$ sudo apt install build-essential \
                   curl \
                   dfu-util \
                   gcc-arm-none-eabi \
                   gdb-multiarch \
                   git \
                   python \
                   python-pip
</code></pre>
<p>or on Arch Linux:</p>
<pre><code>$ sudo pacman -S curl \
                 dfu-util \
                 git \
                 python \
                 python-pip
$ yaourt -S arm-none-eabi-gcc \
            gdb-multiarch
</code></pre>
<p>It is convenient to join the <code>dialout</code> group. This way you will not need
super-user privileges to work with BMP and USB-to-UART adapter:</p>
<pre><code class="language-shell">$ sudo adduser $(id -un) dialout
</code></pre>
<p>or the <code>uucp</code> group on Arch Linux:</p>
<pre><code class="language-shell">$ sudo gpasswd -a $(id -un) uucp
</code></pre>
<p>In order for the group change to take effect, you will need to re-login.</p>
<p>Get the stm32loader script and install its python dependencies:</p>
<pre><code class="language-shell">$ git clone https://github.com/jsnyder/stm32loader
$ pip install pyserial
</code></pre>
<p>Get the BMP firmware:</p>
<pre><code class="language-shell">$ git clone https://github.com/blacksphere/blackmagic
$ cd blackmagic
$ git submodule update --init --recursive
</code></pre>
<p>BMP repository provides udev rules for the probe. The rules instruct udev to
symlink the GDB endpoint to <code>/dev/ttyBmpGdb</code> and the UART to
<code>/dev/ttyBmpTarg</code>. Also they allow to upgrade BMP firmware without super-user
permissions.</p>
<pre><code class="language-shell">$ sudo cp driver/99-blackmagic.rules /etc/udev/rules.d/
$ sudo udevadm control --reload-rules
</code></pre>
<h2 id="building"><a class="header" href="#building">Building</a></h2>
<p>Correct probe host should be selected. In our case it's <code>swlink</code>.</p>
<pre><code class="language-shell">$ make PROBE_HOST=swlink
</code></pre>
<p><img src="./assets/blackmagic-make.png" alt="Building" /></p>
<p>This will produce two binaries we are interested in: <code>src/blackmagic_dfu.bin</code>
and <code>src/blackmagic.bin</code>. The first is a bootloader, which will be flashed with
the USB-to-UART adapter. And the second is the actual firmware, which will be
loaded through USB with help of the bootloader.</p>
<h2 id="flashing-bootloader"><a class="header" href="#flashing-bootloader">Flashing Bootloader</a></h2>
<ol>
<li>
<p>Connect the USB-to-UART adapter with the Blue Pill according to this table:</p>
<table><thead><tr><th>USB-to-UART</th><th>Blue Pill</th></tr></thead><tbody>
<tr><td>GND</td><td>GND</td></tr>
<tr><td>RXD</td><td>A9</td></tr>
<tr><td>TXD</td><td>A10</td></tr>
</tbody></table>
<p><strong>Warning:</strong> Don't connect any power source now. We will power up the board
through USB at the step 5. Using USB together with 5V or 3.3 pins can damage
your board.</p>
</li>
<li>
<p>Set the jumper on the USB-to-UART adapter to the position where VCC and 3V3
are shorted. This will set the adapter's output voltage to 3.3 v. Although it
is not strictly needed, because A9 and A10 pins are five-volt-tolerant.</p>
</li>
<li>
<p>Set BOOT0 jumper on the Blue Pill to 1 to boot into the factory programmed
bootloader. The bootloader is responsible for programming the board through
UART.</p>
</li>
</ol>
<p><img src="./assets/bluepill-ch340g.jpg" alt="CH340G connected to Blue Pill" /></p>
<ol start="4">
<li>
<p>Before connecting the USB-to-UART adapter to your PC, open the system
journal:</p>
<pre><code class="language-shell">$ journalctl -f
</code></pre>
<p>Connect the USB-to-UART adapter and notice the name it is assigned:</p>
</li>
</ol>
<p><img src="./assets/ch340g-journal.png" alt="CH340G in journal" /></p>
<ol start="5">
<li>
<p>Connect a USB-cable to the Blue Pill and start the flashing process. Replace
<code>/dev/ttyUSB0</code> with your value from the previous step. If the process is not
starting, press the reset button on the Blue Pill.</p>
<pre><code class="language-shell">$ ../stm32loader/stm32loader.py -p /dev/ttyUSB0 -e -w -v src/blackmagic_dfu.bin
</code></pre>
</li>
</ol>
<p><img src="./assets/stm32loader.png" alt="Successful load" /></p>
<ol start="6">
<li>Set BOOT0 jumper on the Blue Pill back to 0.</li>
</ol>
<p><img src="./assets/bluepill-jumpers.jpg" alt="Reset Blue Pill jumpers" /></p>
<h2 id="flashing-firmware"><a class="header" href="#flashing-firmware">Flashing Firmware</a></h2>
<p>Now you can disconnect the USB-to-UART adapter from the Blue Pill and your
PC. The firmware will be flashed through USB port:</p>
<pre><code class="language-shell">$ dfu-util -d 1d50:6018,:6017 -s 0x08002000:leave -D src/blackmagic.bin
</code></pre>
<p><img src="./assets/dfu-util.png" alt="Successful load" /></p>
<p>Now we will check that it works. Reconnect the Blue Pill and open a GDB session:</p>
<pre><code class="language-shell">$ gdb-multiarch
</code></pre>
<p>At the GDB prompt enter the following commands:</p>
<pre><code class="language-text">target extended-remote /dev/ttyBmpGdb
monitor version
</code></pre>
<p><img src="./assets/gdb-monitor-version.png" alt="GDB check" /></p>
<p>If your output is similar to the output above, congratulations! Now your Blue
Pill is a Black Magic Probe! Next time you need to upgrade the firmware you only
need to repeat the <code>dfu-util</code> command above.</p>
<h2 id="wiring"><a class="header" href="#wiring">Wiring</a></h2>
<p>Here is a general pin-out description and an example connection with a Blue
Pill:</p>
<table><thead><tr><th>Black Magic Probe</th><th>Function</th><th>Blue Pill Target</th></tr></thead><tbody>
<tr><td>GND</td><td>GND</td><td>GND</td></tr>
<tr><td>SWCLK</td><td>JTCK/SWCLK</td><td>SWCLK</td></tr>
<tr><td>SWIO</td><td>JTMS/SWDIO</td><td>SWIO</td></tr>
<tr><td>A15</td><td>JTDI</td><td></td></tr>
<tr><td>B3</td><td>JTDO</td><td></td></tr>
<tr><td>B4</td><td>JNTRST</td><td>R</td></tr>
<tr><td>B6</td><td>UART1 TX</td><td></td></tr>
<tr><td>B7</td><td>UART1 RX</td><td>B3</td></tr>
<tr><td>A3</td><td>UART2 RX (TRACESWO)</td><td></td></tr>
</tbody></table>
<p><img src="./assets/bmp-wiring.jpg" alt="BMP wiring" /></p>
<h2 id="comparison-with-official-bmp"><a class="header" href="#comparison-with-official-bmp">Comparison with Official BMP</a></h2>
<p><img src="./assets/official-bmp-comparison.jpg" alt="Blue Pill and Official BMP" /></p>
<p>There are a few advantages of the official BMP:</p>
<ul>
<li>Has a Cortex Debug connector</li>
<li>Can power the target</li>
<li>Can sense the target's voltage</li>
<li>Has more LEDs</li>
<li>Has more robust circuitry</li>
</ul>
<p>These advantages are not critical, however by buying the official hardware you
are supporting the BMP project.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="hardware.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="hello-world.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="hardware.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="hello-world.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        
        <!-- Google Analytics Tag -->
        <script type="text/javascript">
            var localAddrs = ["localhost", "127.0.0.1", ""];

            // make sure we don't activate google analytics if the developer is
            // inspecting the book locally...
            if (localAddrs.indexOf(document.location.hostname) === -1) {
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-148590307-2', 'auto');
                ga('send', 'pageview');
            }
        </script>
        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
